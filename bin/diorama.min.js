"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,r){var t=[],n=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(t.push(s.value),!r||t.length!==r);n=!0);}catch(e){i=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(i)throw a}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),Diorama=function(){function e(){_classCallCheck(this,e),this.assetCache={models:{},textures:{},videos:{}},this.scene=new THREE.Scene,this.previewCamera=new THREE.OrthographicCamera,this.scene.add(this.previewCamera),altspace.inClient?(this.renderer=altspace.getThreeJSRenderer(),Promise.all([altspace.getEnclosure(),altspace.getSpace()]).then(function(e){var r=_slicedToArray(e,2),t=r[0],n=r[1];this.env=Object.freeze({innerHeight:t.innerHeight,innerWidth:t.innerWidth,innerDepth:t.innerDepth,pixelsPerMeter:t.pixelsPerMeter,sid:n.sid,name:n.name,templateSid:n.templateSid}),this.scene.scale.multiplyScalar(t.pixelsPerMeter)})):(this.renderer=new THREE.WebGLRenderer,this.renderer.setSize(720,720),this.renderer.setClearColor(8947848),document.body.appendChild(this.renderer.domElement),altspace.utilities.shims.cursor.init(scene,camera,{renderer:renderer}),this.env=Object.freeze({innerWidth:1024,innerHeight:1024,innerDepth:1024,pixelsPerMeter:1024/3,sid:"browser",name:"browser",templateSid:"browser"}))}return _createClass(e,[{key:"start",value:function(){for(var r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];t.forEach(function(r){var t=new THREE.Object3D;this.scene.add(t),e.loadAssets(r.assets,function(e){r.initialize(env,t,e)})}),window.requestAnimationFrame(function e(r){window.requestAnimationFrame(e),this.scene.updateAllBehaviors(),this.renderer.render(this.scene,this.camera)})}},{key:"loadAssets",value:function(r){var t=this;return new Promise(function(n,i){Promise.all([Promise.all(Object.keys(r.models||{}).map(function(n){var i=r.models[n];return t.assetCache.models[i]?Promise.resolve(t.assetCache.models[i]):e.ModelPromise(i).then(function(e){t.assetCache.models[i]=e})})),Promise.all(Object.keys(r.textures||{}).map(function(n){var i=r.textures[n];return t.assetCache.textures[i]?Promise.resolve(t.assetCache.textures[i]):e.TexturePromise(i).then(function(e){t.assetCache.textures[i]=e})}))]).catch(function(){return i.apply(void 0,arguments)}).then(function(){var e={models:{},textures:{}};for(var i in r.models)e.models[i]=t.assetCache.models[r.models[i]];for(var a in r.textures)e.textures[a]=t.assetCache.textures[r.textures[a]];n(e)})})}}]),e}();window.Diorama.ModelPromise=function(e){return new Promise(function(r,t){if(/\.gltf$/.test(e)){var n=new THREE.glTFLoader;n.load(e,function(e){r(e.scene.children[0].children[0])})}})},window.Diorama.TexturePromise=function(e){return new Promise(function(r,t){var n=new THREE.TextureLoader;n.load(e,r,null,t)})},window.Diorama.VideoPromise=function(e){var r=document.createElement("video");r.autoplay=!0,r.loop=!0,r.src=e,r.style.display="none",document.body.appendChild(r);var t=new THREE.VideoTexture(r);return t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.format=THREE.RGBFormat,Promise.resolve(t)};