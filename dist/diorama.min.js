"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _slicedToArray=function(){function e(e,t){var r=[],o=!0,n=!1,i=void 0;try{for(var a,s=e[Symbol.iterator]();!(o=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);o=!0);}catch(e){n=!0,i=e}finally{try{!o&&s.return&&s.return()}finally{if(n)throw i}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}(),Diorama=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.bgColor,o=void 0===r?11184810:r,n=t.gridOffset,i=void 0===n?new THREE.Vector3:n;_classCallCheck(this,e);var a=this;a.assetCache={models:{},textures:{},videos:{}},a.scene=new THREE.Scene,altspace.inClient?(a.renderer=altspace.getThreeJSRenderer(),a._envPromise=Promise.all([altspace.getEnclosure(),altspace.getSpace()]).then(function(e){var t=_slicedToArray(e,2),r=t[0],o=t[1];a.env=Object.freeze(Object.assign({},r,o)),a.scene.scale.multiplyScalar(r.pixelsPerMeter)})):(a.renderer=new THREE.WebGLRenderer,a.renderer.setSize(document.body.clientWidth,document.body.clientHeight),a.renderer.setClearColor(o),document.body.appendChild(a.renderer.domElement),a.previewCamera=new e.PreviewCamera,a.previewCamera.gridHelper.position.copy(i),a.scene.add(a.previewCamera,a.previewCamera.gridHelper),a.previewCamera.registerHooks(a.renderer),altspace.utilities.shims.cursor.init(a.scene,a.previewCamera,{renderer:a.renderer}),a.env=Object.freeze({innerWidth:1024,innerHeight:1024,innerDepth:1024,pixelsPerMeter:1024/3,sid:"browser",name:"browser",templateSid:"browser"}))}return _createClass(e,[{key:"start",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];var o=this;if(!o.env)return o._envPromise.then(function(){o.start.apply(o,t)});var n={};t.forEach(function(e){function t(e){void 0===n[e]?n[e]=!0:n[e]===!0&&(n[e]=!1)}Object.keys(e.assets.textures||{}).map(function(t){return e.assets.textures[t]}).forEach(t),Object.keys(e.assets.models||{}).map(function(t){return e.assets.models[t]}).forEach(t)});var i=t.reduce(function(e,t){return e||t.needsSkeleton},!1);i&&altspace.inClient&&altspace.getThreeJSTrackingSkeleton().then(function(e){o.scene.add(e),o.env.skel=e}),t.forEach(function(e){var t=null;if(e instanceof THREE.Object3D?t=e:(t=new THREE.Object3D,e.transform?(t.matrix.fromArray(e.transform),t.matrix.decompose(t.position,t.quaternion,t.scale)):(e.position&&t.position.fromArray(e.position),e.rotation&&t.rotation.fromArray(e.rotation))),e.verticalAlign){var r=o.env.innerHeight/(2*o.env.pixelsPerMeter);switch(e.verticalAlign){case"top":t.translateY(r);break;case"bottom":t.translateY(-r);break;case"middle":break;default:console.warn('Invalid value for "verticalAlign" - ',e.verticalAlign)}}o.scene.add(t),o.previewCamera&&t.add(new THREE.AxisHelper(1)),o.loadAssets(e.assets,n).then(function(r){e.initialize(o.env,t,r)})}),window.requestAnimationFrame(function e(t){window.requestAnimationFrame(e),o.scene.updateAllBehaviors(),window.TWEEN&&TWEEN.update(),o.renderer.render(o.scene,o.previewCamera)})}},{key:"loadAssets",value:function(t,r){function o(e){return new Promise(function(t,r){function o(){0===--n&&t()}var n=e.length;e.forEach(function(e){e.then(o,o)})})}var n=this;return new Promise(function(i,a){o([Promise.all(Object.keys(t.models||{}).map(function(r){var o=t.models[r];return n.assetCache.models[o]?Promise.resolve(n.assetCache.models[o]):e.ModelPromise(o).then(function(e){n.assetCache.models[o]=e})})),Promise.all(Object.keys(t.textures||{}).map(function(r){var o=t.textures[r];return n.assetCache.textures[o]?Promise.resolve(n.assetCache.textures[o]):e.TexturePromise(o).then(function(e){n.assetCache.textures[o]=e})}))]).then(function(){var e={models:{},textures:{}};for(var o in t.models){var a=t.models[o],s=n.assetCache.models[a];e.models[o]=s?r[a]?s:s.clone():null}for(var c in t.textures){var l=t.textures[c],u=n.assetCache.textures[l];e.textures[c]=u?r[l]?u:u.clone():null}i(e)})})}}]),e}();THREE.glTFLoader=THREE.glTFLoader||THREE.GLTFLoader,Diorama.ModelPromise=function(e){return new Promise(function(t,r){if(/\.gltf$/i.test(e))if(THREE.glTFLoader){var o=new THREE.glTFLoader;o.load(e,function(e){t(e.scene.children[0].children[0])})}else console.error('THREE.glTFLoader not found. "'+e+'" not loaded.'),r();else if(/\.dae$/i.test(e))if(THREE.ColladaLoader){var n=new THREE.ColladaLoader;n.load(e,function(e){return t(e.scene.children[0])},null,r)}else console.error('THREE.ColladaLoader not found. "'+e+'" not loaded.'),r()})},Diorama.TexturePromise=function(e){return new Promise(function(t,r){var o=new THREE.TextureLoader;o.load(e,t,null,r)})},Diorama.VideoPromise=function(e){var t=document.createElement("video");t.autoplay=!0,t.loop=!0,t.src=e,t.style.display="none",document.body.appendChild(t);var r=new THREE.VideoTexture(t);return r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r.format=THREE.RGBFormat,Promise.resolve(r)};var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}();Diorama.PreviewCamera=function(e){function t(e,r,o){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,-1,1,1,-1,.1,400)),i=window.localStorage.getItem("dioramaViewSettings");return i&&(i=JSON.parse(i),e||(e=(new THREE.Vector3).fromArray(i.focus)),r||(r=i.viewSize),o||(o=(new THREE.Vector3).fromArray(i.lookDirection))),n._viewSize=r||40,n._focus=e||new THREE.Vector3,n._lookDirection=o||new THREE.Vector3(0,(-1),0),n.gridHelper=new THREE.GridHelper(300,1),n}return _inherits(t,e),_createClass(t,[{key:"registerHooks",value:function(e){var t=this;t.renderer=e,document.body.parentElement.style.height="100%",document.body.style.height="100%",document.body.style.margin="0",document.body.style.overflow="hidden";var r=document.createElement("p");r.innerHTML=["Middle click and drag to pan","Mouse wheel to zoom","Arrow keys to rotate"].join("<br/>"),Object.assign(r.style,{position:"fixed",top:"10px",left:"10px",margin:0}),document.body.appendChild(r),window.addEventListener("resize",function(e){return t.recomputeViewport()}),t.recomputeViewport();var o=null,n=null;window.addEventListener("mousedown",function(e){1===e.button&&(o={x:e.clientX,y:e.clientY},n=t._focus.clone())}),window.addEventListener("mouseup",function(e){1===e.button&&(o=null,n=null)}),window.addEventListener("mousemove",function(e){if(o){var r=document.body,i=r.clientWidth,a=r.clientHeight,s=Math.sqrt(i*i+a*a)/t._viewSize,c=e.clientX-o.x,l=e.clientY-o.y,u=(new THREE.Vector3).crossVectors(t._lookDirection,t.up);t._focus.copy(n).add(t.up.clone().multiplyScalar(l/s)).add(u.multiplyScalar(-c/s)),t.recomputeViewport()}}),window.addEventListener("wheel",function(e){e.deltaY<0?(t._viewSize*=.9,t.recomputeViewport()):e.deltaY>0&&(t._viewSize*=1.1,t.recomputeViewport())}),window.addEventListener("keydown",function(e){if("ArrowDown"===e.key){var r=(new THREE.Vector3).crossVectors(t._lookDirection,t.up);t._lookDirection.applyAxisAngle(r,Math.PI/2),t.recomputeViewport()}else if("ArrowUp"===e.key){var o=(new THREE.Vector3).crossVectors(t._lookDirection,t.up);t._lookDirection.applyAxisAngle(o,-Math.PI/2),t.recomputeViewport()}else"ArrowLeft"===e.key?(t._lookDirection.applyAxisAngle(t.up,-Math.PI/2),t.recomputeViewport()):"ArrowRight"===e.key&&(t._lookDirection.applyAxisAngle(t.up,Math.PI/2),t.recomputeViewport())})}},{key:"recomputeViewport",value:function(){var e=document.body,t=e.clientWidth,r=e.clientHeight;this.renderer.setSize(t,r);var o=t/r,n=Math.sqrt(this._viewSize*this._viewSize/(o*o+1)),i=o*n;this.left=-i/2,this.right=i/2,this.top=n/2,this.bottom=-n/2,this.updateProjectionMatrix(),this.position.copy(this._focus).sub(this._lookDirection.clone().multiplyScalar(200)),1===Math.abs(this._lookDirection.normalize().dot(new THREE.Vector3(0,(-1),0)))?this.up.set(0,0,1):this.up.set(0,1,0),this.lookAt(this._focus),window.localStorage.setItem("dioramaViewSettings",JSON.stringify({focus:this._focus.toArray(),viewSize:this._viewSize,lookDirection:this._lookDirection.toArray()}))}},{key:"viewSize",get:function(){return this._viewSize},set:function(e){this._viewSize=e,this.recomputeViewport()}},{key:"focus",get:function(){return this._focus},set:function(e){this._focus.copy(e),this.recomputeViewport()}},{key:"lookDirection",get:function(){return this._lookDirection},set:function(e){this._lookDirection.copy(e),this.recomputeViewport()}}]),t}(THREE.OrthographicCamera);