"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _slicedToArray=function(){function e(e,r){var t=[],n=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(t.push(s.value),!r||t.length!==r);n=!0);}catch(e){a=!0,i=e}finally{try{!n&&o.return&&o.return()}finally{if(a)throw i}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),Diorama=function(){function e(){_classCallCheck(this,e);var r=this;r.assetCache={models:{},textures:{},videos:{}},r.scene=new THREE.Scene,r.previewCamera=new THREE.OrthographicCamera,r.scene.add(r.previewCamera),altspace.inClient?(r.renderer=altspace.getThreeJSRenderer(),Promise.all([altspace.getEnclosure(),altspace.getSpace()]).then(function(e){var t=_slicedToArray(e,2),n=t[0],a=t[1];r.env=Object.freeze({innerHeight:n.innerHeight,innerWidth:n.innerWidth,innerDepth:n.innerDepth,pixelsPerMeter:n.pixelsPerMeter,sid:a.sid,name:a.name,templateSid:a.templateSid}),r.scene.scale.multiplyScalar(n.pixelsPerMeter)})):(r.renderer=new THREE.WebGLRenderer,r.renderer.setSize(720,720),r.renderer.setClearColor(8947848),document.body.appendChild(r.renderer.domElement),altspace.utilities.shims.cursor.init(r.scene,r.previewCamera,{renderer:r.renderer}),r.env=Object.freeze({innerWidth:1024,innerHeight:1024,innerDepth:1024,pixelsPerMeter:1024/3,sid:"browser",name:"browser",templateSid:"browser"}))}return _createClass(e,[{key:"start",value:function(){for(var e=this,r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];t.forEach(function(r){var t=new THREE.Object3D;e.scene.add(t),e.loadAssets(r.assets).then(function(n){r.initialize(e.env,t,n)})}),window.requestAnimationFrame(function r(t){window.requestAnimationFrame(r),e.scene.updateAllBehaviors(),e.renderer.render(e.scene,e.previewCamera)})}},{key:"loadAssets",value:function(r){var t=this;return new Promise(function(n,a){Promise.all([Promise.all(Object.keys(r.models||{}).map(function(n){var a=r.models[n];return t.assetCache.models[a]?Promise.resolve(t.assetCache.models[a]):e.ModelPromise(a).then(function(e){t.assetCache.models[a]=e})})),Promise.all(Object.keys(r.textures||{}).map(function(n){var a=r.textures[n];return t.assetCache.textures[a]?Promise.resolve(t.assetCache.textures[a]):e.TexturePromise(a).then(function(e){t.assetCache.textures[a]=e})}))]).catch(function(){return a.apply(void 0,arguments)}).then(function(){var e={models:{},textures:{}};for(var a in r.models)e.models[a]=t.assetCache.models[r.models[a]];for(var i in r.textures)e.textures[i]=t.assetCache.textures[r.textures[i]];n(e)})})}}]),e}();window.Diorama.ModelPromise=function(e){return new Promise(function(r,t){if(/\.gltf$/.test(e)){var n=new THREE.glTFLoader;n.load(e,function(e){r(e.scene.children[0].children[0])})}})},window.Diorama.TexturePromise=function(e){return new Promise(function(r,t){var n=new THREE.TextureLoader;n.load(e,r,null,t)})},window.Diorama.VideoPromise=function(e){var r=document.createElement("video");r.autoplay=!0,r.loop=!0,r.src=e,r.style.display="none",document.body.appendChild(r);var t=new THREE.VideoTexture(r);return t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.format=THREE.RGBFormat,Promise.resolve(t)};