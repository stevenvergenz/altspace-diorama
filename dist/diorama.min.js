"use strict";function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function _inherits(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}var _slicedToArray=function(){function e(e,r){var t=[],n=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),Diorama=function(){function e(){_classCallCheck(this,e);var r=this;r.assetCache={models:{},textures:{},videos:{}},r.scene=new THREE.Scene,altspace.inClient?(r.renderer=altspace.getThreeJSRenderer(),Promise.all([altspace.getEnclosure(),altspace.getSpace()]).then(function(e){var t=_slicedToArray(e,2),n=t[0],i=t[1];r.env=Object.freeze({innerHeight:n.innerHeight,innerWidth:n.innerWidth,innerDepth:n.innerDepth,pixelsPerMeter:n.pixelsPerMeter,sid:i.sid,name:i.name,templateSid:i.templateSid}),r.scene.scale.multiplyScalar(n.pixelsPerMeter)})):(r.renderer=new THREE.WebGLRenderer,r.renderer.setSize(window.innerWidth,window.innerHeight),r.renderer.setClearColor(8947848),document.body.appendChild(r.renderer.domElement),r.previewCamera=new e.PreviewCamera,r.scene.add(r.previewCamera),r.previewCamera.registerHooks(r.renderer),altspace.utilities.shims.cursor.init(r.scene,r.previewCamera,{renderer:r.renderer}),r.env=Object.freeze({innerWidth:1024,innerHeight:1024,innerDepth:1024,pixelsPerMeter:1024/3,sid:"browser",name:"browser",templateSid:"browser"}))}return _createClass(e,[{key:"start",value:function(){for(var e=this,r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];t.forEach(function(r){var t=new THREE.Object3D;e.scene.add(t),e.loadAssets(r.assets).then(function(n){r.initialize(e.env,t,n)})}),window.requestAnimationFrame(function r(t){window.requestAnimationFrame(r),e.scene.updateAllBehaviors(),e.renderer.render(e.scene,e.previewCamera)})}},{key:"loadAssets",value:function(r){var t=this;return new Promise(function(n,i){Promise.all([Promise.all(Object.keys(r.models||{}).map(function(n){var i=r.models[n];return t.assetCache.models[i]?Promise.resolve(t.assetCache.models[i]):e.ModelPromise(i).then(function(e){t.assetCache.models[i]=e})})),Promise.all(Object.keys(r.textures||{}).map(function(n){var i=r.textures[n];return t.assetCache.textures[i]?Promise.resolve(t.assetCache.textures[i]):e.TexturePromise(i).then(function(e){t.assetCache.textures[i]=e})}))]).catch(function(){return i.apply(void 0,arguments)}).then(function(){var e={models:{},textures:{}};for(var i in r.models)e.models[i]=t.assetCache.models[r.models[i]];for(var o in r.textures)e.textures[o]=t.assetCache.textures[r.textures[o]];n(e)})})}}]),e}();window.Diorama.ModelPromise=function(e){return new Promise(function(r,t){if(/\.gltf$/.test(e)){var n=new THREE.glTFLoader;n.load(e,function(e){r(e.scene.children[0].children[0])})}})},window.Diorama.TexturePromise=function(e){return new Promise(function(r,t){var n=new THREE.TextureLoader;n.load(e,r,null,t)})},window.Diorama.VideoPromise=function(e){var r=document.createElement("video");r.autoplay=!0,r.loop=!0,r.src=e,r.style.display="none",document.body.appendChild(r);var t=new THREE.VideoTexture(r);return t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter,t.format=THREE.RGBFormat,Promise.resolve(t)};var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}();Diorama.PreviewCamera=function(e){function r(){var e=arguments.length<=0||void 0===arguments[0]?new THREE.Vector3:arguments[0],t=arguments.length<=1||void 0===arguments[1]?20:arguments[1],n=arguments.length<=2||void 0===arguments[2]?new THREE.Vector3(0,(-1),0):arguments[2];_classCallCheck(this,r);var i=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,-1,1,1,-1,.1,400));return i.viewSize=t,i.focus=e,i.lookDirection=n,i}return _inherits(r,e),_createClass(r,[{key:"registerHooks",value:function(e){this.renderer=e,document.body.style.margin="0",this.resizeViewport()}},{key:"resizeViewport",value:function(){this.renderer.setSize(window.innerWidth,window.innerHeight);var e=window.innerWidth/window.innerHeight,r=Math.sqrt(this.viewSize*this.viewSize/(e*e+1)),t=e*r;this.left=-t/2,this.right=t/2,this.top=r/2,this.bottom=-r/2,this.updateProjectionMatrix(),this.position.copy(this.focus).sub(this.lookDirection.clone().multiplyScalar(200)),this.lookAt(this.focus)}}]),r}(THREE.OrthographicCamera);