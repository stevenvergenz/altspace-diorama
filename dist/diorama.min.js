"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _slicedToArray=function(){function e(e,t){var r=[],n=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw o}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),Diorama=function(){function e(){_classCallCheck(this,e);var t=this;t.assetCache={models:{},textures:{},videos:{}},t.scene=new THREE.Scene,altspace.inClient?(t.renderer=altspace.getThreeJSRenderer(),Promise.all([altspace.getEnclosure(),altspace.getSpace()]).then(function(e){var r=_slicedToArray(e,2),n=r[0],i=r[1];t.env=Object.freeze({innerHeight:n.innerHeight,innerWidth:n.innerWidth,innerDepth:n.innerDepth,pixelsPerMeter:n.pixelsPerMeter,sid:i.sid,name:i.name,templateSid:i.templateSid}),t.scene.scale.multiplyScalar(n.pixelsPerMeter)})):(t.renderer=new THREE.WebGLRenderer,t.renderer.setSize(window.innerWidth,window.innerHeight),t.renderer.setClearColor(8947848),document.body.appendChild(t.renderer.domElement),t.previewCamera=new e.PreviewCamera,t.scene.add(t.previewCamera),t.previewCamera.registerHooks(t.renderer),altspace.utilities.shims.cursor.init(t.scene,t.previewCamera,{renderer:t.renderer}),t.env=Object.freeze({innerWidth:1024,innerHeight:1024,innerDepth:1024,pixelsPerMeter:1024/3,sid:"browser",name:"browser",templateSid:"browser"}))}return _createClass(e,[{key:"start",value:function(){for(var e=this,t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];r.forEach(function(t){var r=new THREE.Object3D;e.scene.add(r),e.loadAssets(t.assets).then(function(n){t.initialize(e.env,r,n)})}),window.requestAnimationFrame(function t(r){window.requestAnimationFrame(t),e.scene.updateAllBehaviors(),e.renderer.render(e.scene,e.previewCamera)})}},{key:"loadAssets",value:function(t){var r=this;return new Promise(function(n,i){Promise.all([Promise.all(Object.keys(t.models||{}).map(function(n){var i=t.models[n];return r.assetCache.models[i]?Promise.resolve(r.assetCache.models[i]):e.ModelPromise(i).then(function(e){r.assetCache.models[i]=e})})),Promise.all(Object.keys(t.textures||{}).map(function(n){var i=t.textures[n];return r.assetCache.textures[i]?Promise.resolve(r.assetCache.textures[i]):e.TexturePromise(i).then(function(e){r.assetCache.textures[i]=e})}))]).catch(function(){return i.apply(void 0,arguments)}).then(function(){var e={models:{},textures:{}};for(var i in t.models)e.models[i]=r.assetCache.models[t.models[i]].clone();for(var o in t.textures)e.textures[o]=r.assetCache.textures[t.textures[o]].clone();n(e)})})}}]),e}();window.Diorama.ModelPromise=function(e){return new Promise(function(t,r){if(/\.gltf$/i.test(e)){var n=new THREE.glTFLoader;n.load(e,function(e){t(e.scene.children[0].children[0])})}else if(/\.dae$/i.test(e)){console.log("loading collada");var i=new THREE.ColladaLoader;i.load(e,function(e){t(e.scene.children[0])})}})},window.Diorama.TexturePromise=function(e){return new Promise(function(t,r){var n=new THREE.TextureLoader;n.load(e,t,null,r)})},window.Diorama.VideoPromise=function(e){var t=document.createElement("video");t.autoplay=!0,t.loop=!0,t.src=e,t.style.display="none",document.body.appendChild(t);var r=new THREE.VideoTexture(t);return r.minFilter=THREE.LinearFilter,r.magFilter=THREE.LinearFilter,r.format=THREE.RGBFormat,Promise.resolve(r)};var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();Diorama.PreviewCamera=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?new THREE.Vector3:arguments[0],r=arguments.length<=1||void 0===arguments[1]?20:arguments[1],n=arguments.length<=2||void 0===arguments[2]?new THREE.Vector3(0,(-1),0):arguments[2];_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,-1,1,1,-1,.1,400));return i._viewSize=r,i._focus=e,i._lookDirection=n,i}return _inherits(t,e),_createClass(t,[{key:"registerHooks",value:function(e){this.renderer=e,document.body.style.margin="0",this.recomputeViewport()}},{key:"recomputeViewport",value:function(){this.renderer.setSize(window.innerWidth,window.innerHeight);var e=window.innerWidth/window.innerHeight,t=Math.sqrt(this._viewSize*this._viewSize/(e*e+1)),r=e*t;this.left=-r/2,this.right=r/2,this.top=t/2,this.bottom=-t/2,this.updateProjectionMatrix(),this.position.copy(this._focus).sub(this._lookDirection.clone().multiplyScalar(200)),1===Math.abs(this._lookDirection.normalize().dot(new THREE.Vector3(0,(-1),0)))?this.up.set(0,0,1):this.up.set(0,1,0),this.lookAt(this._focus)}},{key:"viewSize",get:function(){return this._viewSize},set:function(e){this._viewSize=e,this.recomputeViewport()}},{key:"focus",get:function(){return this._focus},set:function(e){this._focus.copy(e),this.recomputeViewport()}},{key:"lookDirection",get:function(){return this._lookDirection},set:function(e){this._lookDirection.copy(e),this.recomputeViewport()}}]),t}(THREE.OrthographicCamera);